x-playwright-base: &playwright-base
  image: mcr.microsoft.com/playwright:v1.58.1-jammy
  working_dir: /app
  volumes:
    - ../..:/app
    - playwright_node_modules:/app/node_modules
  network_mode: host
  ipc: host
  entrypoint: /bin/sh -c

services:
  playwright:
    <<: *playwright-base
    environment:
      - CI=${CI:-false}
    command:
      - |
        npm install -g pnpm@10.8.1
        pnpm install --frozen-lockfile
        npx playwright test -c libs/core/playwright.config.ts

  playwright-ui:
    <<: *playwright-base
    environment:
      - CI=false
    command:
      - |
        npm install -g pnpm@10.8.1
        pnpm install --frozen-lockfile
        npx playwright test -c libs/core/playwright.config.ts --ui --ui-port=8077 --ui-host=localhost

  update-snapshots:
    <<: *playwright-base
    environment:
      - CI=false
    command:
      - |
        npm install -g pnpm@10.8.1
        pnpm install --frozen-lockfile
        npx playwright test -c libs/core/playwright.config.ts --update-snapshots

  playwright-coverage:
    <<: *playwright-base
    environment:
      - CI=${CI:-false}
      - COVERAGE=true
    command:
      - |
        npm install -g pnpm@10.8.1
        pnpm install --frozen-lockfile
        COVERAGE=true npx playwright test -c libs/core/playwright.config.ts
        npx nyc report --reporter=text --reporter=text-summary --reporter=html --reporter=lcov --reporter=json-summary
        echo ""
        echo "âœ“ Coverage report generated in libs/core/coverage/e2e/"

volumes:
  playwright_node_modules:
