name: Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

permissions:
  contents: write
  
env:
  DEPENDENCIES_CACHE: cache-node-modules

jobs:
  install-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/use-cache
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install

  build:
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/use-cache
      - uses: nrwl/nx-set-shas@v4
      - run: npx nx run-many -t build -c production --parallel --max-parallel=6

  test:
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/use-cache
      - name: Run unit tests with coverage
        run: npx nx run core:test --coverage
      - name: Generate coverage summary
        id: coverage
        run: |
          if [ -f libs/core/coverage/unit/coverage-summary.json ]; then
            COVERAGE=$(node -e "const c = require('./libs/core/coverage/unit/coverage-summary.json'); console.log(c.total.lines.pct)")
            echo "unit_coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "### Unit Test Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Upload unit test coverage report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: coverage-report-unit
          path: libs/core/coverage/unit/
          retention-days: 30

  lint:
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/use-cache
      - run: npx nx run-many -t lint --parallel --max-parallel=6

  e2e-core:
    runs-on: ubuntu-latest
    needs: install-deps
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/use-cache
      - name: Run core e2e tests with coverage
        run: npx nx run core:e2e:coverage
        env:
          CI: true
          COVERAGE: true
      - name: Generate coverage summary
        id: coverage
        run: |
          if [ -f libs/core/coverage/e2e/coverage-summary.json ]; then
            COVERAGE=$(node -e "const c = require('./libs/core/coverage/e2e/coverage-summary.json'); console.log(c.total.lines.pct)")
            echo "e2e_coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "### E2E Test Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report-core
          path: libs/core/playwright-report/
          retention-days: 30
      - name: Upload E2E coverage report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: coverage-report-e2e
          path: libs/core/coverage/e2e/
          retention-days: 30

  update-coverage-badge:
    runs-on: ubuntu-latest
    needs: [test, e2e-core]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/use-cache
      - name: Download unit coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-unit
          path: libs/core/coverage/unit/
      - name: Download e2e coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-report-e2e
          path: libs/core/coverage/e2e/
      - name: Generate coverage badge JSON
        run: |
          mkdir -p .github/badges
          
          # Get unit coverage
          UNIT_COV=0
          if [ -f libs/core/coverage/unit/coverage-summary.json ]; then
            UNIT_COV=$(node -e "const c = require('./libs/core/coverage/unit/coverage-summary.json'); console.log(c.total.lines.pct)")
          fi
          
          # Get e2e coverage  
          E2E_COV=0
          if [ -f libs/core/coverage/e2e/coverage-summary.json ]; then
            E2E_COV=$(node -e "const c = require('./libs/core/coverage/e2e/coverage-summary.json'); console.log(c.total.lines.pct)")
          fi
          
          # Calculate combined (average)
          COMBINED=$(node -e "console.log(Math.round(($UNIT_COV + $E2E_COV) / 2 * 10) / 10)")
          
          # Determine color
          if (( $(echo "$COMBINED >= 80" | bc -l) )); then
            COLOR="brightgreen"
          elif (( $(echo "$COMBINED >= 60" | bc -l) )); then
            COLOR="yellow"
          elif (( $(echo "$COMBINED >= 40" | bc -l) )); then
            COLOR="orange"
          else
            COLOR="red"
          fi
          
          # Create badge JSON for shields.io endpoint
          cat > .github/badges/coverage.json << EOF
          {
            "schemaVersion": 1,
            "label": "coverage",
            "message": "${COMBINED}%",
            "color": "${COLOR}"
          }
          EOF
          
          echo "Unit: ${UNIT_COV}%, E2E: ${E2E_COV}%, Combined: ${COMBINED}%"
          cat .github/badges/coverage.json
      - name: Commit coverage badge
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/badges/coverage.json
          git diff --staged --quiet || git commit -m "chore: update coverage badge [skip ci]"
          git push
